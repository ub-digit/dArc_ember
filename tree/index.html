<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>dArc</title>
  <link rel="stylesheet" href="dist/themes/default/style.min.css" />
</head>
<body>
  <div>
    <input type="checkbox" id="showDeleted"> <label for="showDeleted"> Show deleted </label>
    | <label for="extFilter"> Extension: </label> <input type="text" id="extFilter">
  </div>
  <div id="using_json">
  </div>

  <script src="dist/libs/jquery.js"></script>
  <script src="dist/jstree.min.js"></script>
  <script src="dist/jstreegrid.js"></script> 
  <script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.7.0/underscore-min.js"></script>
  <script src="../config.js"></script>

  <script>
  $(function() {
    function create_tree() {
      var disk_image = window.location.hash.substr(1);

      if(disk_image) {
        $('#using_json').jstree({
          plugins: ['core','grid'],
          core: {
            data: function(obj, cb) {
              if(obj.id === '#') {
                cb.call(this, [{
                  id: 2,
                  text: 'root',
                  children: true,
                }]);

                $.ajax({
                  url: CONFIG.SERVER.URL + "/diskimages/" + disk_image,
                }).done(function(data) {
                  cb.call(this, _(data.diskimage.volumes).chain()
                    .sortBy('id')
                    .map(function(node, index) {
                      return {
                        id: node.id + '_' + 2,
                        data: { 'id': 2, 'volume': node.id },
                        text: 'Volume ' + (index + 1) + ' (' + node.id + ')',
                        children: true,
                      };
                    })
                    .value()
                  );
                });
              } else {
                $.get(
                  CONFIG.SERVER.URL + "/content_file_infos/" + disk_image + "/" + obj.data.volume + "/" + obj.data.id,
                  {
                    showDeleted: $('#showDeleted').is(':checked'),
                    extFilter: $('#extFilter').val(),
                  }
                ).done(function(data) {
                  cb.call(this, _(data.content_file_infos).chain()
                    .reject(function(node) { return node.class === 'hide'; })
                    .map(function(node) {
                      return {
                        id: obj.data.volume + '_' + node.inode,
                        data: $.extend({}, node, { id: node.inode, volume: obj.data.volume }),
                        text: node.name,
                        children: node.name_type !== 'r',
                        icon: node.name_type === 'r' ? 'jstree-file' : 'jstree-folder',
                      };
                    })
                    .value()
                  );
                });
              }
            }
          },
          grid: {
            columns: [{
              header: 'Name',
              width: 'auto',
              title: 'libmagic',
            }, {
              header: 'Size',
              value: 'filesize',
              width: 200,
            }, {
              header: 'Modified',
              value: function(node) { return node.mtime ? node.mtime.value : ''; },
              width: 300,
            }],
          },
        });
      }
    }

    function recreate_tree() {
      $("#using_json").jstree('destroy');
      create_tree();
    }

    $('#showDeleted').change(recreate_tree);
    $('#extFilter').change(recreate_tree);

    create_tree();

  });
  </script>
</body>
</html>
