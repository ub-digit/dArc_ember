<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>dArc</title>
  <link rel="stylesheet" href="dist/themes/default/style.min.css" />
</head>
<body>
  <div>
  <input type="checkbox" id="showDeleted"> showDeleted
  | <input type="text" id="extFilter"> ext
  </div>
  <div id="using_json">
  </div>

  <script src="dist/libs/jquery.js"></script>
  <script src="dist/jstree.min.js"></script>
  <script src="dist/jstreegrid.js"></script> 
  <script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.7.0/underscore-min.js"></script>
  <script src="../config.js"></script>

  <script>
  $(function() {
    var create_tree = function() {
      var root_node = window.location.hash.substr(1);

      if(root_node) {
        $('#using_json').jstree({
          plugins: ['core','grid'],
          core: {
            data: function(obj, cb) {
              if(obj.id === '#') {
                cb.call(this, [{
                  id: 2,
                  text: 'root',
                  children: true,
                }]);

                $.ajax({
                  url: CONFIG.SERVER.URL + "/diskimages/" + root_node,
                }).done(function(data) {
                  var tree_nodes = [];
                  var volume_num = 1;
                  data.diskimage.volumes.sort(function(a, b) { return a.id - b.id; }).forEach(function(node) {
                    tree_nodes.push({
                      id: node.id + '_' + 2,
                      data: { 'id': 2, 'volume': node.id },
                      text: 'Volume ' + volume_num++ + ' (' + node.id + ')',
                      children: true,
                    });
                  });
                  cb.call(this, tree_nodes);
                });
              } else {
                $.ajax({
                  url: CONFIG.SERVER.URL + "/content_file_infos/" + root_node + "/" + obj.data.volume + "/" + obj.data.id + '?showDeleted=' + $('#showDeleted').is(':checked') + '&extFilter=' + $('#extFilter').val(),
                }).done(function(data) {
                  var tree_nodes = [];
                  data.content_file_infos.forEach(function(node) {
                    if(node.class !== 'hide') {
                      tree_nodes.push({
                        id: obj.data.volume + '_' + node.inode,
                        data: $.extend({}, node, { id: node.inode, volume: obj.data.volume }),
                        text: node.name,
                        children: node.name_type !== 'r',
                        icon: node.name_type === 'r' ? 'jstree-file' : 'jstree-folder',
                      });
                    }
                  });
                  cb.call(this, tree_nodes);
                });
              }
            }
          },
          grid: {
            columns: [{
              header: 'Name',
              width: 'auto',
              title: 'libmagic',
            }, {
              header: 'Size',
              value: 'filesize',
              width: 200,
            }, {
              header: 'Modified',
              value: function(node) { return node.mtime ? node.mtime.value : ''; },
              width: 300,
            }],
          },
        });
      }
    }

    $('#showDeleted').click(function() {
      $("#using_json").jstree('destroy');
      create_tree();
    });
    $('#extFilter').click(function() {
      $("#using_json").jstree('destroy');
      create_tree();
    });

    create_tree();

  });
  </script>
</body>
</html>
